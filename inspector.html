<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Inspector</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; line-height: 1.6; padding: 15px; }
        h1 { color: #bb86fc; }
        #controls { margin-bottom: 20px; display: flex; gap: 10px; }
        #productId { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #333; background-color: #2c2c2c; color: #e0e0e0; font-size: 1em; }
        #inspectBtn { padding: 10px 15px; border: none; border-radius: 4px; background-color: #03dac6; color: #121212; font-weight: bold; cursor: pointer; }
        .result-box { border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #1e1e1e; }
        .title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .status { padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .status.ok { background-color: #03dac6; color: #121212; }
        .status.fail { background-color: #cf6679; color: #121212; }
        .data { margin-top: 10px; background-color: #2c2c2c; padding: 10px; border-radius: 4px; font-family: "Courier New", Courier, monospace; font-size: 0.9em; white-space: pre-wrap; word-break: break-all; }
        .diagnosis { border-top: 1px solid #333; margin-top: 15px; padding-top: 15px; }
    </style>
</head>
<body>

    <h1>Инспектор Товаров</h1>
    <p>Вставьте ID товара из Firestore, чтобы проверить его данные и соответствие требованиям запроса.</p>
    
    <div id="controls">
        <input type="text" id="productId" placeholder="Вставьте ID товара здесь...">
        <button id="inspectBtn">Проверить товар</button>
    </div>

    <div id="results"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk",
            authDomain: "wine-91d0e.firebaseapp.com",
            projectId: "wine-91d0e",
            storageBucket: "wine-91d0e.firebasestorage.app",
            messagingSenderId: "1021620433427",
            appId: "1:1021620433427:web:5439252fb350c4455a85e6",
            measurementId: "G-TRWHY3KXK1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const resultsContainer = document.getElementById('results');
        const inspectBtn = document.getElementById('inspectBtn');
        const productIdInput = document.getElementById('productId');

        async function inspectProduct() {
            const productId = productIdInput.value.trim();
            if (!productId) {
                resultsContainer.innerHTML = '<div class="result-box"><span class="status fail">ОШИБКА</span><div class="data">Пожалуйста, введите ID товара.</div></div>';
                return;
            }
            resultsContainer.innerHTML = '<div class="result-box"><div class="data">Загрузка...</div></div>';

            try {
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    resultsContainer.innerHTML = '<div class="result-box"><span class="status fail">ОШИБКА</span><div class="data">Товар с таким ID не найден. Проверьте правильность ID.</div></div>';
                    return;
                }

                const data = docSnap.data();
                let dataHtml = '';
                for (const key in data) {
                    dataHtml += `${key}: ${JSON.stringify(data[key])} (тип: ${typeof data[key]})\n`;
                }

                // Проводим проверку
                const isArchivedExists = 'isArchived' in data;
                const isArchivedFalse = isArchivedExists && data.isArchived === false;
                const popularityExists = 'popularity' in data;
                const popularityIsNumber = popularityExists && typeof data.popularity === 'number';

                let diagnosisHtml = `
                    <div class="diagnosis">
                        <div class="title">Диагностический чек-лист:</div>
                        <div>
                            1. Поле 'isArchived' существует и равно 'false': 
                            <span class="status ${isArchivedFalse ? 'ok' : 'fail'}">${isArchivedFalse ? 'ДА' : 'НЕТ'}</span>
                        </div>
                        <div>
                            2. Поле 'popularity' существует: 
                            <span class="status ${popularityExists ? 'ok' : 'fail'}">${popularityExists ? 'ДА' : 'НЕТ'}</span>
                        </div>
                        <div>
                            3. Поле 'popularity' является числом (number): 
                            <span class="status ${popularityIsNumber ? 'ok' : 'fail'}">${popularityIsNumber ? 'ДА' : 'НЕТ'}</span>
                        </div>
                    </div>
                `;
                
                let finalDiagnosis = '';
                if (isArchivedFalse && popularityExists && popularityIsNumber) {
                    finalDiagnosis = '<div class="title" style="color: #03dac6;">ДИАГНОЗ: Все в порядке! Этот товар должен отображаться. Если он не виден, проблема может быть в кэше.</div>';
                } else {
                    finalDiagnosis = '<div class="title" style="color: #cf6679;">ДИАГНОЗ: Товар не соответствует требованиям запроса. Исправьте поля, отмеченные как "НЕТ".</div>';
                }
                diagnosisHtml += finalDiagnosis;


                resultsContainer.innerHTML = `
                    <div class="result-box">
                        <div class="title">Данные товара (ID: ${productId})</div>
                        <div class="data">${dataHtml}</div>
                        ${diagnosisHtml}
                    </div>
                `;

            } catch (error) {
                resultsContainer.innerHTML = `<div class="result-box"><span class="status fail">КРИТИЧЕСКАЯ ОШИБКА</span><div class="data">${error.message}</div></div>`;
            }
        }

        inspectBtn.addEventListener('click', inspectProduct);
    </script>

</body>
</html>