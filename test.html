<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Product Fetch Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; padding: 2rem; }
        #output { background-color: #1e1e1e; border: 1px solid #333; padding: 1rem; border-radius: 8px; font-family: "Courier New", Courier, monospace; line-height: 1.6; }
        p { margin: 0 0 0.5rem 0; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>Firestore Connection Test for VinoElite</h1>
    <p>This page attempts to perform the exact same initial product query as your catalog page. The results below will identify the problem.</p>
    <div id="output"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // 1. ИМПОРТИРУЕМ НУЖНЫЕ ФУНКЦИИ FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // 2. ВАША КОНФИГУРАЦИЯ FIREBASE (без изменений)
        const firebaseConfig = {
          apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk",
          authDomain: "wine-91d0e.firebaseapp.com",
          projectId: "wine-91d0e",
          storageBucket: "wine-91d0e.firebasestorage.app",
          messagingSenderId: "1021620433427",
          appId: "1:1021620433427:web:5439252fb350c4455a85e6",
          measurementId: "G-TRWHY3KXK1"
        };

        // 3. ИНИЦИАЛИЗАЦИЯ
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const outputEl = document.getElementById('output');

        function log(message, className = 'info') {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = className;
            outputEl.appendChild(p);
        }

        // 4. ОСНОВНАЯ ТЕСТОВАЯ ФУНКЦИЯ
        async function runTest() {
            log("Starting test...");
            try {
                // 5. СОЗДАЕМ ТОЧНО ТАКОЙ ЖЕ ЗАПРОС, КАК В catalog.js
                log("Building query: collection('products'), where('isArchived', '==', false), orderBy('name'), limit(12)");
                
                const productsRef = collection(db, 'products');
                const testQuery = query(
                    productsRef,
                    where("isArchived", "==", false),
                    orderBy('name'), // <-- Поле, которое мы подозреваем
                    limit(12)
                );

                // 6. ВЫПОЛНЯЕМ ЗАПРОС
                log("Executing query against Firestore...");
                const querySnapshot = await getDocs(testQuery);
                log("Query executed successfully!", 'success');
                
                // 7. АНАЛИЗИРУЕМ РЕЗУЛЬТАТ
                log(`Found ${querySnapshot.size} documents.`);

                if (querySnapshot.empty) {
                    log("RESULT: The query worked, but returned 0 products. Please check your database and make sure you have products where the 'isArchived' field is set to 'false'.", 'warning');
                } else {
                    log("RESULT: Success! Products loaded. This means the problem is likely in the main catalog.js file, not with the data itself. Here are the loaded products:", 'success');
                    querySnapshot.forEach(doc => {
                        const product = doc.data();
                        // Проверяем наличие поля 'name' для наглядности
                        const name = product.name ? product.name : "!!! NAME FIELD IS MISSING OR EMPTY !!!";
                        log(`  - ID: ${doc.id}, Name: ${name}`);
                    });
                }

            } catch (error) {
                // 8. ЛОВИМ ОШИБКУ
                log("--- TEST FAILED ---", 'error');
                log(`This error is the reason your catalog is empty.`, 'error');
                log(`Error Code: ${error.code}`, 'error');
                log(`Error Message: ${error.message}`, 'error');
                
                if (error.code === 'failed-precondition') {
                    log("DIAGNOSIS: This error means you are MISSING A FIRESTORE INDEX. Open the browser's developer console (F12), find the full error message, and click the link it provides to create the index automatically.", 'error');
                } else if (error.code === 'invalid-argument') {
                    log("DIAGNOSIS: This error strongly suggests that at least ONE of your product documents is MISSING THE 'name' FIELD, or the field has a wrong data type. Please check every product in your database.", 'error');
                } else {
                    log("DIAGNOSIS: An unexpected error occurred. Check your Security Rules or the network tab in the developer console for more details.", 'error');
                }
            }
        }

        runTest();
    </script>
</body>
</html>