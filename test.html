<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Диагностика страницы товара</title>
    <style>
        body { font-family: monospace; background: #f0f0f0; padding: 20px; }
        h1 { color: #333; }
        p { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: bold; }
        .info { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
    </style>
</head>
<body>
    <h1>Запуск диагностики страницы товара...</h1>
    <div id="log-container"></div>

    <script type="module">
        // Контейнер для вывода логов на страницу
        const logContainer = document.getElementById('log-container');
        const logStatus = (message, type = 'info') => {
            const p = document.createElement('p');
            p.textContent = message;
            p.className = type; // 'success', 'error', или 'info'
            logContainer.appendChild(p);
        };

        logStatus('1. Скрипт начал выполняться.', 'info');

        try {
            // ===============================================================
            // ШАГ 2: ИМПОРТ FIREBASE SDK
            // ===============================================================
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            import { getFirestore, collection, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
            logStatus('2. Модули Firebase SDK успешно импортированы.', 'success');

            // ===============================================================
            // ШАГ 3: ИНИЦИАЛИЗАЦИЯ FIREBASE
            // ===============================================================
            const firebaseConfig = { apiKey: "AIzaSyBflzOWVf3HgDpdUhha3qvyeUJf7i6dOuk", authDomain: "wine-91d0e.firebaseapp.com", projectId: "wine-91d0e", storageBucket: "wine-91d0e.firebasestorage.app", messagingSenderId: "1021620433427", appId: "1:1021620433427:web:5439252fb350c4455a85e6", measurementId: "G-TRWHY3KXK1" };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            logStatus('3. Firebase приложение успешно инициализировано.', 'success');

            // ===============================================================
            // ШАГ 4: ПОЛУЧЕНИЕ SLUG ТОВАРА ИЗ URL
            // ===============================================================
            const getProductSlugFromUrl = () => {
                // ВАЖНО: Для test.html путь будет /test.html/catalog/category/slug
                // Поэтому мы берем последнюю часть после разделения по '/'
                const path = window.location.pathname;
                const parts = path.split('/').filter(part => part && part !== 'test.html');
                return parts.length > 0 ? parts[parts.length - 1] : null;
            };
            const productSlug = getProductSlugFromUrl();
            
            if (productSlug) {
                logStatus(`4. Slug товара успешно получен из URL: "${productSlug}"`, 'success');

                // ===============================================================
                // ШАГ 5: ЗАПРОС К БАЗЕ ДАННЫХ ДЛЯ ПОИСКА ТОВАРА
                // ===============================================================
                try {
                    const q = query(collection(db, "products"), where("slug", "==", productSlug), limit(1));
                    logStatus('5.1. Запрос к базе данных Firestore сформирован. Выполняю...', 'info');
                    
                    const querySnapshot = await getDocs(q);
                    logStatus('5.2. Ответ от базы данных получен.', 'success');

                    if (querySnapshot.empty) {
                        logStatus(`5.3. РЕЗУЛЬТАТ: Продукт со slug "${productSlug}" НЕ НАЙДЕН в базе данных.`, 'error');
                    } else {
                        const productData = querySnapshot.docs[0].data();
                        logStatus(`5.3. РЕЗУЛЬТАТ: Продукт "${productData.name}" успешно НАЙДЕН!`, 'success');
                    }
                } catch (dbError) {
                    logStatus(`ОШИБКА на шаге 5: Не удалось выполнить запрос к базе данных. ${dbError.message}`, 'error');
                }

            } else {
                logStatus('4. ОШИБКА: Не удалось получить slug товара из URL. Убедитесь, что URL имеет вид /test.html/catalog/category/product-slug', 'error');
            }

        } catch (e) {
            logStatus(`КРИТИЧЕСКАЯ ОШИБКА: ${e.message}`, 'error');
        }

        logStatus('6. Диагностика завершена.', 'info');
    </script>
</body>
</html>